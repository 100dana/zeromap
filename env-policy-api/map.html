<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>스마트서울맵</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        #map {
            width: 100%;
            height: 100%;
        }
        .marker-info {
            background: white;
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            max-width: 250px;
        }
        .marker-title {
            font-weight: bold;
            margin-bottom: 4px;
            color: #333;
        }
        .marker-address {
            font-size: 12px;
            color: #666;
            margin-bottom: 4px;
        }
        .marker-category {
            font-size: 11px;
            color: #007AFF;
            background: #E3F2FD;
            padding: 2px 6px;
            border-radius: 4px;
            display: inline-block;
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <script>
        // 스마트서울맵 API 설정
        const SMART_SEOUL_API_KEY = 'YOUR_SMART_SEOUL_API_KEY'; // 실제 API 키로 교체 필요
        const BASE_URL = 'https://map.seoul.go.kr/smgis2/smap';
        
        let map;
        let markers = [];
        let currentInfoWindow = null;

        // React Native와의 통신을 위한 메시지 전송 함수
        function sendMessageToReactNative(data) {
            if (window.ReactNativeWebView) {
                window.ReactNativeWebView.postMessage(JSON.stringify(data));
            }
        }

        // 지도 초기화
        function initMap() {
            // 서울시청 좌표
            const seoulCenter = { lat: 37.5665, lng: 126.9780 };
            
            // 기본 지도 생성 (OpenLayers 또는 Leaflet 사용)
            map = L.map('map').setView([seoulCenter.lat, seoulCenter.lng], 12);
            
            // OpenStreetMap 타일 레이어 추가
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);

            // 지도 클릭 이벤트
            map.on('click', function(e) {
                sendMessageToReactNative({
                    type: 'mapClick',
                    coordinates: {
                        latitude: e.latlng.lat,
                        longitude: e.latlng.lng
                    }
                });
            });

            console.log('지도 초기화 완료');
        }

        // 마커 추가 함수
        function addMarkers(places) {
            // 기존 마커들 제거
            clearMarkers();
            
            places.forEach((place, index) => {
                const marker = L.marker([place.latitude, place.longitude])
                    .addTo(map)
                    .bindPopup(createPopupContent(place));
                
                markers.push(marker);
                
                // 마커 클릭 이벤트
                marker.on('click', function() {
                    sendMessageToReactNative({
                        type: 'markerClick',
                        data: place
                    });
                });
            });
            
            console.log(`${places.length}개의 마커 추가됨`);
        }

        // 마커 제거 함수
        function clearMarkers() {
            markers.forEach(marker => {
                map.removeLayer(marker);
            });
            markers = [];
        }

        // 팝업 콘텐츠 생성
        function createPopupContent(place) {
            return `
                <div class="marker-info">
                    <div class="marker-title">${place.name}</div>
                    <div class="marker-address">${place.address}</div>
                    <div class="marker-category">${place.category}</div>
                </div>
            `;
        }

        // 지도 중심 이동
        function moveToLocation(lat, lng, zoom = 15) {
            map.setView([lat, lng], zoom);
        }

        // 스마트서울맵 API로 데이터 가져오기
        async function loadSmartSeoulData(category = '제로웨이스트') {
            try {
                // 실제 구현에서는 서버를 통해 API 호출
                const response = await fetch(`/api/smart-seoul/places?category=${encodeURIComponent(category)}`);
                const places = await response.json();
                
                addMarkers(places);
                return places;
            } catch (error) {
                console.error('스마트서울맵 데이터 로드 실패:', error);
                return [];
            }
        }

        // React Native로부터 메시지 수신
        function handleMessageFromReactNative(message) {
            try {
                const data = JSON.parse(message);
                
                switch (data.type) {
                    case 'addMarkers':
                        addMarkers(data.places);
                        break;
                    case 'moveToLocation':
                        moveToLocation(data.latitude, data.longitude, data.zoom);
                        break;
                    case 'loadCategory':
                        loadSmartSeoulData(data.category);
                        break;
                    case 'clearMarkers':
                        clearMarkers();
                        break;
                }
            } catch (error) {
                console.error('메시지 처리 오류:', error);
            }
        }

        // 페이지 로드 시 초기화
        window.addEventListener('load', function() {
            // Leaflet CSS 로드
            const link = document.createElement('link');
            link.rel = 'stylesheet';
            link.href = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css';
            document.head.appendChild(link);
            
            // Leaflet JS 로드 후 지도 초기화
            const script = document.createElement('script');
            script.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
            script.onload = function() {
                initMap();
                
                // React Native에 준비 완료 메시지 전송
                sendMessageToReactNative({
                    type: 'mapReady'
                });
            };
            document.head.appendChild(script);
        });

        // React Native로부터 메시지 수신 설정
        document.addEventListener('message', function(event) {
            handleMessageFromReactNative(event.data);
        });
    </script>
</body>
</html> 